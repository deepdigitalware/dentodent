version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    command: ${BACKEND_COMMAND:-node backend/server-local-fs.js}
    environment:
      - NODE_ENV=production
      - PORT=4444
      # Optional SMTP configuration for form emails
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-}
      - GMAIL_USER=${GMAIL_USER:-}
      - GMAIL_APP_PASSWORD=${GMAIL_APP_PASSWORD:-}
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - FROM_EMAIL=${FROM_EMAIL:-no-reply@dentodentdentalclinic.com}
      - EMAIL_RECIPIENTS=${EMAIL_RECIPIENTS:-deepversestudio@gmail.com,drsetketuchakraborty@gmail.com}
    labels:
      - "coolify.managed=true"
      - "traefik.enable=true"
      - "traefik.http.routers.dod-backend.rule=Host(`api.dentodentdentalclinic.com`)"
      - "traefik.http.routers.dod-backend.entrypoints=websecure"
      - "traefik.http.routers.dod-backend.tls=true"
      - "traefik.http.routers.dod-backend.service=dod-backend"
      - "traefik.docker.network=coolify"
      - "traefik.http.services.dod-backend.loadbalancer.server.port=4444"
    volumes:
      - backend_data:/app/backend/data
      - backend_uploads:/app/backend/public/assets/uploads
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4444/health', r => { process.exit(r.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "4444:4444"
    networks:
      - coolify

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    command: node backend/frontend-server.js
    environment:
      - NODE_ENV=production
      - FRONTEND_PORT=4000
      - API_URL=http://backend:4444
    labels:
      - "coolify.managed=true"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/health', r => { process.exit(r.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "4000:4000"
    networks:
      - coolify

  admin:
    build:
      context: .
      dockerfile: Dockerfile
    command: node backend/admin-server.js
    environment:
      - NODE_ENV=production
      - ADMIN_PORT=4001
      - API_URL=http://backend:4444
    labels:
      - "coolify.managed=true"
      - "traefik.enable=true"
      - "traefik.http.routers.dod-admin.rule=Host(`admin.dentodentdentalclinic.com`)"
      - "traefik.http.routers.dod-admin.entrypoints=websecure"
      - "traefik.http.routers.dod-admin.tls=true"
      - "traefik.http.routers.dod-admin.service=dod-admin"
      - "traefik.docker.network=coolify"
      - "traefik.http.services.dod-admin.loadbalancer.server.port=4001"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4001/api/health', r => { process.exit(r.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "4001:4001"
    networks:
      - coolify

networks:
  coolify:
    external: true

volumes:
  backend_data:
  backend_uploads:
